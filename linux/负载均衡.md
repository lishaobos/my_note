# 负载均衡架构

## 概述

负载均衡(Load Balance)是高并发、高可用系统的关键技术,通过将请求分发到多个服务器来提高系统的处理能力和可靠性。

根据工作在 OSI 网络模型的不同层次,负载均衡主要分为:
- **四层负载均衡**(传输层)
- **七层负载均衡**(应用层)

---

## 一、四层负载均衡(L4 Load Balance)

### 1.1 工作原理

四层负载均衡工作在 **OSI 模型的传输层**(第4层),主要基于 **IP 地址和端口号** 进行流量分发。

**核心机制**:
- 通过修改数据包的目标 IP 地址和端口,将请求转发到后端服务器
- 不解析应用层协议(如 HTTP),只处理 TCP/UDP 连接
- 使用 NAT(网络地址转换)技术实现流量转发

### 1.2 技术特点

| 特点 | 说明 |
|------|------|
| **性能** | 非常高,不需要解析应用层数据,处理速度快 |
| **透明性** | 对应用层完全透明,支持任何基于 TCP/UDP 的协议 |
| **灵活性** | 较低,无法基于应用层内容(URL、Cookie等)做决策 |
| **会话保持** | 基于源 IP 或端口进行会话保持 |
| **延迟** | 低延迟,转发速度快 |

### 1.3 常见实现技术

#### LVS (Linux Virtual Server)
```bash
# LVS 工作模式
- NAT模式: 修改目标IP,性能一般
- DR模式(Direct Routing): 直接路由,性能最高
- TUN模式(IP Tunneling): 通过隧道转发
```

**典型配置示例**:
```bash
# 使用 ipvsadm 配置 LVS
ipvsadm -A -t 192.168.1.100:80 -s rr  # 添加虚拟服务,轮询算法
ipvsadm -a -t 192.168.1.100:80 -r 192.168.1.10:80 -g  # 添加真实服务器(DR模式)
ipvsadm -a -t 192.168.1.100:80 -r 192.168.1.11:80 -g
```

#### Nginx Stream 模块
```nginx
stream {
    upstream backend {
        server 192.168.1.10:3306;
        server 192.168.1.11:3306;
    }
    
    server {
        listen 3306;
        proxy_pass backend;
    }
}
```

#### HAProxy (TCP 模式)
```haproxy
frontend mysql_frontend
    bind *:3306
    mode tcp
    default_backend mysql_backend

backend mysql_backend
    mode tcp
    balance roundrobin
    server mysql1 192.168.1.10:3306 check
    server mysql2 192.168.1.11:3306 check
```

### 1.4 适用场景

- **数据库负载均衡**: MySQL、Redis、MongoDB 等
- **非 HTTP 协议**: SMTP、FTP、SSH 等
- **高性能要求**: 需要极低延迟和极高吞吐量的场景
- **协议无关**: 需要支持任意 TCP/UDP 协议的场景

---

## 二、七层负载均衡(L7 Load Balance)

### 2.1 工作原理

七层负载均衡工作在 **OSI 模型的应用层**(第7层),能够解析应用层协议(如 HTTP、HTTPS)的内容,根据具体的请求内容进行智能分发。

**核心机制**:
- 完全解析 HTTP 请求(URL、Header、Cookie 等)
- 根据应用层信息做路由决策
- 可以修改 HTTP 请求和响应内容
- 支持 SSL/TLS 卸载

### 2.2 技术特点

| 特点 | 说明 |
|------|------|
| **性能** | 相对较低,需要解析应用层协议,消耗更多 CPU |
| **智能性** | 很高,可以基于 URL、域名、Cookie 等做复杂决策 |
| **灵活性** | 非常高,支持内容路由、URL 重写、A/B 测试等 |
| **会话保持** | 基于 Cookie、Session ID 等应用层信息 |
| **功能** | 丰富,支持缓存、压缩、SSL卸载、WAF 等 |

### 2.3 常见实现技术

#### Nginx (HTTP 模块)
```nginx
http {
    upstream backend {
        # 负载均衡算法
        ip_hash;  # 基于客户端IP的会话保持
        
        server 192.168.1.10:8080 weight=3;
        server 192.168.1.11:8080 weight=2;
        server 192.168.1.12:8080 backup;  # 备用服务器
    }
    
    server {
        listen 80;
        server_name example.com;
        
        # 基于 URL 路径的分发
        location /api/ {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location /static/ {
            proxy_pass http://static_backend;
            proxy_cache my_cache;  # 启用缓存
        }
        
        # 基于请求头的路由
        location / {
            if ($http_user_agent ~* "mobile") {
                proxy_pass http://mobile_backend;
            }
            proxy_pass http://backend;
        }
    }
}
```

#### HAProxy (HTTP 模式)
```haproxy
frontend http_frontend
    bind *:80
    mode http
    
    # 基于域名的路由
    acl is_api hdr(host) -i api.example.com
    acl is_static path_beg /static
    
    use_backend api_backend if is_api
    use_backend static_backend if is_static
    default_backend web_backend

backend web_backend
    mode http
    balance leastconn  # 最少连接数算法
    cookie SERVERID insert indirect nocache
    server web1 192.168.1.10:80 check cookie web1
    server web2 192.168.1.11:80 check cookie web2
```

#### Traefik (现代化云原生负载均衡器)
```yaml
http:
  routers:
    api-router:
      rule: "Host(`api.example.com`) && PathPrefix(`/v1`)"
      service: api-service
      
  services:
    api-service:
      loadBalancer:
        servers:
          - url: "http://192.168.1.10:8080"
          - url: "http://192.168.1.11:8080"
```

### 2.4 负载均衡算法

| 算法 | 说明 | 适用场景 |
|------|------|----------|
| **轮询(Round Robin)** | 依次将请求分配给每台服务器 | 服务器性能相近 |
| **加权轮询(Weighted RR)** | 根据权重分配请求 | 服务器性能不同 |
| **最少连接(Least Connections)** | 选择连接数最少的服务器 | 长连接场景 |
| **IP Hash** | 根据客户端 IP 哈希分配 | 需要会话保持 |
| **URL Hash** | 根据请求 URL 哈希分配 | 缓存命中率优化 |
| **一致性哈希** | 使用一致性哈希算法 | 缓存服务器扩缩容 |

### 2.5 高级功能

#### SSL/TLS 终止(SSL Offloading)
```nginx
server {
    listen 443 ssl http2;
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # 后端使用 HTTP,SSL 在负载均衡器终止
    location / {
        proxy_pass http://backend;
    }
}
```

#### 健康检查
```nginx
upstream backend {
    server 192.168.1.10:8080 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:8080 max_fails=3 fail_timeout=30s;
}
```

#### 限流和熔断
```nginx
# 限制请求速率
limit_req_zone $binary_remote_addr zone=mylimit:10m rate=10r/s;

server {
    location /api/ {
        limit_req zone=mylimit burst=20;
        proxy_pass http://backend;
    }
}
```

### 2.6 适用场景

- **Web 应用**: HTTP/HTTPS 服务的负载均衡
- **微服务架构**: 基于 URL 路径的服务路由
- **A/B 测试**: 根据用户特征分配不同版本
- **灰度发布**: 按比例将流量导向新版本
- **API 网关**: 统一入口,路由、认证、限流等

---

## 三、四层 vs 七层对比

| 对比维度 | 四层负载均衡 | 七层负载均衡 |
|---------|-------------|-------------|
| **OSI 层级** | 传输层(TCP/UDP) | 应用层(HTTP/HTTPS) |
| **转发依据** | IP + 端口 | HTTP 内容(URL、Header、Cookie) |
| **性能** | 极高(几十万 QPS+) | 较高(几万到十几万 QPS) |
| **延迟** | 极低(微秒级) | 较低(毫秒级) |
| **协议支持** | 所有 TCP/UDP 协议 | 主要是 HTTP/HTTPS |
| **会话保持** | 源 IP、端口 | Cookie、Session ID |
| **内容感知** | 不支持 | 支持(可读写 HTTP 内容) |
| **SSL 处理** | 透传 | 可终止和重加密 |
| **应用场景** | 数据库、非 HTTP 服务 | Web 应用、API 网关 |
| **代表产品** | LVS、F5 BIG-IP | Nginx、HAProxy、Traefik |

---

## 四、混合架构(常见部署方案)

在实际生产环境中,通常采用 **四层 + 七层** 的混合架构:

```
                        Internet
                           |
                    [四层负载均衡]
                    (LVS/F5/云LB)
                           |
        +------------------+------------------+
        |                  |                  |
   [七层LB-1]         [七层LB-2]         [七层LB-3]
   (Nginx/HAProxy)    (Nginx/HAProxy)    (Nginx/HAProxy)
        |                  |                  |
   [应用服务器集群]   [应用服务器集群]   [应用服务器集群]
```

**架构优势**:
1. **高可用**: 四层负载均衡器保证七层负载均衡器的高可用
2. **高性能**: 四层处理海量连接,七层做智能路由
3. **灵活性**: 结合两者优势,既高效又智能
4. **扩展性**: 七层负载均衡器可以水平扩展

---

## 五、实践建议

### 5.1 选型建议

- **数据库层**: 优先选择四层负载均衡(LVS、云厂商四层LB)
- **应用层**: 优先选择七层负载均衡(Nginx、HAProxy、Traefik)
- **混合场景**: 四层 + 七层架构,兼顾性能和灵活性

### 5.2 监控指标

- **连接数**: 当前活跃连接、总连接数
- **QPS/TPS**: 每秒请求数/事务数
- **响应时间**: P50、P95、P99 延迟
- **错误率**: 4xx、5xx 错误比例
- **后端健康**: 健康检查状态、可用节点数

### 5.3 注意事项

1. **会话保持**: 根据业务需求选择合适的会话保持策略
2. **健康检查**: 配置主动健康检查,及时剔除故障节点
3. **超时设置**: 合理配置连接超时、读写超时
4. **日志记录**: 记录访问日志,便于问题排查
5. **安全防护**: 配置限流、防 DDoS、WAF 等安全策略

---

## 参考资源

- [Nginx 官方文档](http://nginx.org/en/docs/)
- [HAProxy 文档](http://www.haproxy.org/#docs)
- [LVS 中文站](http://www.linuxvirtualserver.org/zh/)
